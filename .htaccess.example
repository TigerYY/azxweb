# Apache 服务器安全配置示例
# 将此文件重命名为 .htaccess 并放置在网站根目录
# 注意：需要确保 Apache 已启用 mod_headers 和 mod_rewrite 模块

# ============================================
# 1. 强制 HTTPS 重定向
# ============================================
<IfModule mod_rewrite.c>
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
</IfModule>

# ============================================
# 2. HTTP 安全响应头
# ============================================
<IfModule mod_headers.c>
    # HSTS - 强制 HTTPS（1年有效期，包含子域名）
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    
    # 防止点击劫持
    Header always set X-Frame-Options "SAMEORIGIN"
    
    # 防止 MIME 类型嗅探
    Header always set X-Content-Type-Options "nosniff"
    
    # XSS 保护（虽然已过时，但某些旧浏览器仍需要）
    Header always set X-XSS-Protection "1; mode=block"
    
    # Referrer 策略
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    
    # 权限策略（根据实际需求调整）
    Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"
    
    # 内容安全策略（CSP）- 根据实际使用的资源调整
    # 注意：如果使用外部 CDN，需要添加到 script-src 和 style-src
    Header always set Content-Security-Policy "default-src 'self'; script-src 'self' https://cdnjs.cloudflare.com https://cdn.jsdelivr.net 'unsafe-inline'; style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self'; frame-ancestors 'self';"
</IfModule>

# ============================================
# 3. 隐藏服务器信息
# ============================================
<IfModule mod_headers.c>
    # 移除服务器版本信息
    Header unset Server
    Header unset X-Powered-By
</IfModule>

# ============================================
# 4. 文件访问保护
# ============================================
# 禁止访问敏感文件
<FilesMatch "^\.">
    Order allow,deny
    Deny from all
</FilesMatch>

# 保护配置文件
<FilesMatch "(\.htaccess|\.htpasswd|\.ini|\.log|\.sh|\.sql|\.env)$">
    Order allow,deny
    Deny from all
</FilesMatch>

# ============================================
# 5. 防止目录浏览
# ============================================
Options -Indexes

# ============================================
# 6. 字符编码
# ============================================
AddDefaultCharset UTF-8

# ============================================
# 7. 压缩优化（可选）
# ============================================
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json
</IfModule>

# ============================================
# 8. 缓存控制（可选，根据需求调整）
# ============================================
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresByType image/jpg "access plus 1 year"
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/gif "access plus 1 year"
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType image/svg+xml "access plus 1 year"
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
    ExpiresByType text/html "access plus 0 seconds"
</IfModule>
